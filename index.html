<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alkmaar Urban Energy Analytics</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary-dark: #1e272e;
            --accent-red: #c0392b;
            --accent-blue: #2980b9;
            --bg-sidebar: #ffffff;
            --border-muted: #dcdde1;
            --text-main: #2f3640;
            --text-muted: #7f8c8d;
        }

        body { 
            margin: 0; padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; 
            display: flex; color: var(--text-main);
            background-color: #f5f6fa;
        }

        #map { height: 100vh; flex-grow: 1; z-index: 1; }
        
        #side-panel {
            width: 340px; height: 100vh; background: var(--bg-sidebar);
            border-left: 1px solid var(--border-muted); padding: 28px; 
            box-sizing: border-box; overflow-y: auto; z-index: 2;
        }

        /* Technical Floating UI */
        .floating-ui {
            position: absolute; z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            padding: 12px; border-radius: 2px;
            border: 1px solid var(--border-muted);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            font-size: 11px; font-weight: 500;
        }

        #controls { top: 20px; left: 60px; }
        #search-box { top: 20px; left: 240px; display: flex; gap: 8px; }

        input[type="text"] {
            border: 1px solid var(--border-muted); padding: 6px 10px;
            border-radius: 2px; font-size: 11px; width: 120px;
            outline: none;
        }

        button {
            background: var(--primary-dark); color: white; border: none;
            padding: 6px 14px; border-radius: 2px; cursor: pointer;
            font-size: 10px; font-weight: 700; letter-spacing: 0.5px;
        }

        /* Sidebar Typography */
        .pc6-header { 
            font-size: 20px; font-weight: 700; color: var(--primary-dark); 
            margin-bottom: 30px; padding-bottom: 12px;
            border-bottom: 1px solid var(--border-muted);
        }

        .data-group { margin-bottom: 24px; }
        .data-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 6px; }
        .data-value { font-size: 16px; font-weight: 600; color: var(--primary-dark); font-variant-numeric: tabular-nums; }
        
        .placeholder-text { font-size: 12px; color: var(--text-muted); text-align: center; margin-top: 80px; line-height: 1.8; }

        /* Legend Enhancement */
        .info.legend { 
            background: white; padding: 12px; border: 1px solid var(--border-muted);
            font-size: 10px; line-height: 1.6; border-radius: 2px;
        }
        .info.legend i { width: 12px; height: 12px; float: left; margin-right: 8px; opacity: 0.6; }
    </style>
</head>
<body>

<div id="controls" class="floating-ui">
    <div style="margin-bottom: 10px; color: var(--text-muted); font-size: 9px; font-weight: bold;">METRIC SELECTION</div>
    <input type="radio" name="layer" value="gas" id="r-gas" checked> <label for="r-gas">GAS CONSUMPTION (m³)</label><br>
    <div style="margin-top: 5px;"></div>
    <input type="radio" name="layer" value="elec" id="r-elec"> <label for="r-elec">ELEC CONSUMPTION (kWh)</label>
</div>

<div id="search-box" class="floating-ui">
    <input type="text" id="search-input" placeholder="eg 1815AG">
    <button id="search-btn">SEARCH</button>
</div>

<div id="map"></div>
<div id="side-panel">
    <div id="panel-content">
        <div class="placeholder-text">
            <strong>SYSTEM INITIALIZED</strong><br>
            Alkmaar PC6 Spatial Data Interface<br><br>
            Select a postcode region to view localized energy profiles.
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { zoomControl: false }).setView([52.632, 4.753], 13);
    L.control.zoom({ position: 'bottomleft' }).addTo(map);
    
    // Restored Original OpenStreetMap Base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap',
        opacity: 0.85
    }).addTo(map);

    let pc6Layer;
    let currentMetric = 'gas';

    // Professional Red/Blue Gradients
    function getColor(d, type) {
        if (type === 'gas') {
            // High-Contrast Red Scale
            return d > 1500 ? '#800026' : d > 1200 ? '#bd0026' : d > 1000 ? '#e31a1c' :
                   d > 800  ? '#fc4e2a' : d > 600  ? '#fd8d3c' : d > 400  ? '#feb24c' : '#fed976';
        } else {
            // High-Contrast Blue Scale
            return d > 4000 ? '#084594' : d > 3500 ? '#2171b5' : d > 3000 ? '#4292c6' :
                   d > 2500 ? '#6baed6' : d > 2000 ? '#9ecae1' : d > 1500 ? '#c6dbef' : '#deebf7';
        }
    }

    function style(feature) {
        const val = currentMetric === 'gas' ? feature.properties.p6_gasm3_2023 : feature.properties.p6_kwh_2023;
        return { 
            fillColor: getColor(val, currentMetric), 
            weight: 0.8, 
            opacity: 0.4, 
            color: '#ffffff', 
            fillOpacity: 0.55 // Increased transparency for better street visibility
        };
    }

    async function loadMap() {
        try {
            const resp = await fetch('alkmaar_energy_map.geojson');
            const data = await resp.json();

            pc6Layer = L.geoJSON(data, {
                style: style,
                onEachFeature: (feature, layer) => {
                    layer.on({
                        mouseover: (e) => e.target.setStyle({ weight: 2, color: '#2f3640', fillOpacity: 0.7 }),
                        mouseout: (e) => pc6Layer.resetStyle(e.target),
                        click: (e) => {
                            updateSidePanel(feature.properties);
                            map.fitBounds(e.target.getBounds(), { padding: [40, 40], maxZoom: 17 });
                        }
                    });
                }
            }).addTo(map);
            if (data.features.length > 0) map.fitBounds(pc6Layer.getBounds());
            updateLegend();
        } catch (e) { console.error("Data load failed:", e); }
    }

    function searchPostcode() {
        const input = document.getElementById('search-input').value.replace(/\s+/g, '').toUpperCase();
        let found = false;
        pc6Layer.eachLayer((layer) => {
            const pc = (layer.feature.properties.postcode6 || "").replace(/\s+/g, '').toUpperCase();
            if (pc === input) {
                found = true;
                updateSidePanel(layer.feature.properties);
                map.fitBounds(layer.getBounds(), { padding: [40, 40] });
                layer.setStyle({weight: 3, color: '#1e272e', fillOpacity: 0.8});
            }
        });
        if (!found) alert("Record not found.");
    }

    document.getElementById('search-btn').addEventListener('click', searchPostcode);
    document.querySelectorAll('input[name="layer"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            currentMetric = e.target.value;
            pc6Layer.setStyle(style);
            updateLegend();
        });
    });

    function updateLegend() {
        const existing = document.querySelector('.legend');
        if (existing) existing.remove();
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function () {
            const div = L.DomUtil.create('div', 'info legend');
            const grades = currentMetric === 'gas' ? [0, 400, 600, 800, 1000, 1200, 1500] : [0, 1500, 2000, 2500, 3000, 3500, 4000];
            const title = currentMetric === 'gas' ? 'GAS (m³)' : 'ELEC (kWh)';
            div.innerHTML = `<div style="margin-bottom:8px; font-weight:700; font-size:9px;">${title}</div>`;
            grades.forEach((g, i) => {
                div.innerHTML += `<i style="background:${getColor(g + 1, currentMetric)}"></i> ${g}${grades[i+1] ? '&ndash;'+grades[i+1] : '+'}<br>`;
            });
            return div;
        };
        legend.addTo(map);
    }

    function updateSidePanel(prop) {
        const formatNum = (val) => (val != null) ? Math.round(val).toLocaleString('nl-NL') : 'N/A';
        document.getElementById('panel-content').innerHTML = `
            <div class="pc6-header">${prop.postcode6}</div>
            
            <div class="data-group">
                <div class="data-label">Gas Consumption (2023)</div>
                <div class="data-value">${formatNum(prop.p6_gasm3_2023)} m³ / yr</div>
            </div>
            
            <div class="data-group">
                <div class="data-label">Electricity Usage (2023)</div>
                <div class="data-value">${formatNum(prop.p6_kwh_2023)} kWh / yr</div>
            </div>
            
            <div class="data-group">
                <div class="data-label">Avg. WOZ Valuation</div>
                <div class="data-value">€ ${formatNum(prop.pc6_gemiddelde_woz_waarde_woning * 1000)}</div>
            </div>

            <div style="margin-top:60px; font-size:9px; color:var(--text-muted); line-height:1.5;">
                <strong>METHODOLOGY</strong><br>
                Geometry: CBS 2021 PC6 Boundaries.<br>
                Energy: P6 Statistics 2023.<br>
                Matched via precision spatial bounding.
            </div>
        `;
    }

    loadMap();
</script>
</body>
</html>